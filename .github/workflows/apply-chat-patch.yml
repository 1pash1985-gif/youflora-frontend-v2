name: Apply Chat Patch

on:
  workflow_dispatch:
    inputs:
      branch:
        description: 'Target branch'
        required: true
        default: 'main'
      patch:
        description: 'Paste unified diff here (git diff -u)'
        required: true

jobs:
  apply:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout target branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.branch }}
          fetch-depth: 0

      - name: Configure git
        run: |
          git config user.name "chat-bot"
          git config user.email "bot@example.com"

      - name: Apply patch
        run: |
          echo "${{ github.event.inputs.patch }}" > _chat.patch
          # пытаемся наложить “чисто”; если конфликты — пишем .rej
          git apply --whitespace=fix _chat.patch || git apply --reject _chat.patch
          git status
          git add -A
          git commit -m "Apply patch from workflow input" || echo "nothing to commit"

      - name: Push to a temporary branch
        run: |
          BR="chat/patch-${{ github.run_id }}"
          git push -u origin HEAD:$BR

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          branch: chat/patch-${{ github.run_id }}
          base: ${{ github.event.inputs.branch }}
          title: "Apply chat patch ${{ github.run_id }}"
          body: |
            Patch applied from workflow input.
            If there were .rej files, resolve them in this PR.
